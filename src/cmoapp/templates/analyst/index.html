{% extends 'analyst/base_site.html' %}
{% load custom_tags %}
{% load widget_tweaks %}

{% block page_stylesheets %}
<style text="text/css">
    /* plz determine if should go into our own css or if remain separate */
    .panel_toolbox
    {
        min-width: 24px;
    }

    #myTab
    {
        margin-bottom: 21px;
        font-size: larger;
    }

    .mail_list h3
    {
        margin-bottom: 0px;
    }

    .mail_list h4
    {
       margin: 0;
       font-weight: bold;
       font-size: 12px;
    }

    .btn-toolbar
    {
        margin-bottom: 10px;
    }

</style>
{% endblock page_stylesheets %}

{% block page_javascripts %}
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDDacnVEtNIWnbMCw_QI94kynm0_ytIalQ&callback=initMap"
  type="text/javascript"></script>

<script type="text/javascript">
    {% if assigned_crisis %}
        //JSON Fucking up.
        var crisis = {{ True|jsonify }}
    {% else %}
        //JSON Fucking up.
        var crisis = {{ False|jsonify }}
    {% endif %}
        var forces = {{ all_forces|jsonify }}
    $(document).ready(function(){
        //initCharts();
        if(!crisis)
        {
            setTimeout(function(){ location.reload() },10000);
        }
        /*
            Help me bind the form submission and figure out a way to display the raw data for the WSIWYG
            $('#mySubmission').val($('#editor').cleanHtml(true));
            $('#submitForm').submit()
            $('#id_description').wysiwyg()
        */
        $("#addForces").on('click',function(){

        });
    });
    function initMap(){
        var map = new google.maps.Map(document.getElementById("map"),{
            zoom: 12,
          center: new google.maps.LatLng(1.3521, 103.8198),
          mapTypeId: 'roadmap'
        });
        var markers;
        var icon_loc = '../static/images/map/'
        var icons = {
            Terrorism: icon_loc + "Terrorism.png",
            Bombing:icon_loc + "Bombing.png",
            Riot: icon_loc + "Riot.png",
            Fire: icon_loc + "Fire.png"
        };

        {% if crisis_reports %}
            {% for crisis in crisis_reports%}

                var cent = new google.maps.LatLng({{crisis.latitude}},{{crisis.longitude}});
                var radius = {{ crisis.radius }};

                var image = {
                  url: icons['{{ crisis.crisisType }}'],
                  //size: new google.maps.Size(100, 100),
                  // The origin for this image is (0, 0).
                  origin: new google.maps.Point(0, 0),
                  // The anchor with respect to the Lat and Long
                  anchor: new google.maps.Point(30, 30)
                };

                var crisisCircle = new google.maps.Circle({
                    strokeColor: '#FF0000',
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillColor: '#FF0000',
                    fillOpacity: 0.35,
                    map: map,
                    center: cent,
                    radius: radius,//in metres (cannot use the loc, wierdly causes the radius to become super big
                });

                var marker = new google.maps.Marker({
                    position: cent,
                    icon: image,
                    map:map
                });
                marker.addListener('click', function() {
                    if($('#{{ crisis.id }}').hasClass("bg-primary")){
                        $('#{{ crisis.id }}').removeClass("bg-primary");
                        new PNotify({
                        title: 'Crisis Report Deselected',
                        text: 'Click marker again to reselect the Crisis Report!',
                        type: 'warning',
                        styling: 'bootstrap3'
                        });
                    }

                    else{
                        $('#{{ crisis.id }}').addClass("bg-primary").parent().siblings().children().removeClass("bg-primary");
                        new PNotify({
                        title: 'Crisis Report Selected',
                        text: 'Check the 911 Reports for more Info!',
                        type: 'success',
                        styling: 'bootstrap3'
                        });

                    }
                });
            {% endfor %}
        {% endif %}
    }

</script>

{% endblock page_javascripts %}

{% block js_templates %}


<script type="text/html" id="template_force_form">
    <input type="text" type="knob" name="">
</script>

{% endblock js_templates %}

{% block content %}
<div class="right_col">
    {% if assigned_crisis %}
    <div class="row">
        <div class="x_panel">
            <div class="x_title">
                <h2>Current Statistics</h2>
                <ul class="nav navbar-right panel_toolbox">
                    <li>
                        <a class="collapse-link">
                            <i class="fa fa-chevron-up"></i>
                        </a>
                    </li>
                </ul>
                <div class="clearfix"></div>
            </div>
            <div class="x_content">
                <div class="row">
                     <div class="animated flipInY col-sm-4 col-xs-12">
                        <div class="tile-stats">
                            <div class="icon">
                                <i class="fa fa-fighter-jet" aria-hidden="true"></i>
                            </div>
                            <div class="count">{{ assigned_crisis.get_status_display }}</div>
                            <h3>Crisis Status</h3>
                        </div>
                    </div>
                    <div class="animated flipInY col-sm-4 col-xs-12">
                        <div class="tile-stats">
                            <div class="icon">
                                <i class="fa fa-ambulance"></i>
                            </div>
                            <div class="count">{{ assigned_crisis.injuries|default:"0" }}</div>
                            <h3>Current Injuries</h3>
                        </div>
                    </div>
                    <div class="animated flipInY col-sm-4 col-xs-12">
                        <div class="tile-stats">
                            <div class="icon">
                                <i class="fa fa-hospital-o" aria-hidden="true"></i>
                            </div>
                            <div class="count">{{ assigned_crisis.deaths|default:"0"}}</div>
                            <h3>Current Deaths</h3>
                        </div>
                    </div>
                </div>
                <div class="row">
                   <div class="x_panel">
                        <div class="x_title">
                            <h2>Current Statistics</h2>
                            <ul class="nav navbar-right panel_toolbox">
                                <li>
                                    <a class="collapse-link">
                                        <i class="fa fa-chevron-up"></i>
                                    </a>
                                </li>
                            </ul>
                            <div class="clearfix"></div>
                        </div>
                        <div class="x_content">
                            <div class="col-sm-12 col-xs-12">
                                <div class="tile-stats row padding">
                                    <h2 class="center">Current Force Utilisation</h2>
                                    <div class="col-sm-1"></div>
                                    {% for force in all_force%}
                                    <div class="animated flipInY col-sm-2 col-xs-12 padding">
                                        <div class="chart" data-percent="{{force.currentUtilisation}}">
                                            <div class ="percent">{{force.currentUtilisation}}%</div>
                                            <h2 class="center">{{force.name}}</h2>
                                        </div>
                                    </div>
                                    {%endfor%}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-sm-6 col-xs-12">
            <div class="x_panel">
                <div class="x_title">
                    <h2>Reports from 911</h2>
                    <ul class="nav navbar-right panel_toolbox">
                        <li>
                            <a class="collapse-link">
                                <i class="fa fa-chevron-up"></i>
                            </a>
                        </li>
                    </ul>
                    <div class="clearfix"></div>
                </div>
                <div class="x_content">
                    <ul class="list-unstyled timeline widget">
                        {% for report in assigned_crisis.crisisreport_set.all %}
                        <li>
                            <div id="{{ report.id }}" class="block">
                                <div class="block_content">
                                    <h2 class="title">{{ report.description }}</h2>
                                    <div class="byline">
                                        <span>{{ report.datetime }}</span>
                                    </div>
                                </div>
                            </div>
                        </li>
                        {% empty %}
                            <span>No Reports Yet</span>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-xs-12">
            <div class="x_panel">
                <div class="x_title">
                    <h2>Reports from Emergency Forces</h2>
                    <ul class="nav navbar-right panel_toolbox">
                        <li>
                            <a class="collapse-link">
                                <i class="fa fa-chevron-up"></i>
                            </a>
                        </li>
                    </ul>
                    <div class="clearfix"></div>
                </div>
                <div class="x_content">
                    <ul class="list-unstyled timeline widget">
                        {% for report in assigned_crisis.efupdate_set.all %}
                        <li>
                            <div class="block">
                                <div class="block_content">
                                    <h2 class="title">{{ report.description }}</h2>
                                    <div class="byline">
                                        <span>{{ report.datetime }}</span>
                                    </div>
                                </div>
                            </div>
                        </li>
                        {% empty %}
                            <span>No Reports Yet</span>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-xs-12">
            <div class="x_panel">
                <div class="x_title">
                    <h2>Crisis Map</h2>
                    <ul class="nav navbar-right panel_toolbox">
                        <li>
                            <a class="collapse-link">
                                <i class="fa fa-chevron-up"></i>
                            </a>
                        </li>
                    </ul>
                    <div class="clearfix"></div>
                </div>
                <div id="map" class="x_content" style="height:600px;">
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div>
            <div class="x_panel">
                <div class="x_title">
                    <h2>Action Plans</h2>
                    <ul class="nav navbar-right panel_toolbox">
                        <li>
                            <a class="collapse-link">
                                <i class="fa fa-chevron-up"></i>
                            </a>
                        </li>
                    </ul>
                    <br>
                </div>
                <div class="x_content">
                    <div id="own" class="col-sm-9 col-xs-12 sideBorder" style="height:100%;">
                        <div role="tabpanel" data-example-id="togglable-tabs">
                          <ul id="myTab" class="nav nav-tabs nav-justified" role="tablist">
                            <li role="presentation" class="active"><a href="#current" id="current-tab" role="tab" data-toggle="tab" aria-expanded="true">Create Action Plan</a>
                            </li>
                            <li role="presentation" class=""><a href="#previous" role="tab" id="previous-tab" data-toggle="tab" aria-expanded="false">Submitted Action Plans</a>
                            </li>
                            <li>
                                <a id="#comments" class="collapse-link-right">
                                    Comments
                                    <i class="fa fa-chevron-right right"></i>
                                </a>
                            </li>
                          </ul>
                          <div id="myTabContent" class="tab-content">
                            <div role="tabpanel" class="tab-pane fade active in" id="current" aria-labelledby="current-tab">
                                <form class="form-horizontal" method="POST">
                                    {% csrf_token %}
                                    {{ form.non_field_errors }}
                                    <div class="col-xs-12 col-sm-8">
                                        <div class="row">
                                            <div class="col-xs-12 col-sm-4 col-sm-offset-4">
                                                <button class="btn btn-block btn-info" id="addForce">Add Forces</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-xs-12 col-sm-8">
                                            <select>
                                                <option>------</option>
                                                {}
                                            </select>  
                                        </div>
                                        <div class="col-xs-12 col-sm-4">
                                            <div class="form-group">
                                            {% render_label ActionPlanForm.type class="control-label" content="Plan Type:" %}
                                            {% render_field ActionPlanForm.type class="form-control" %}
                                            {{ ActionPlanForm.type.errors }}
                                            </div>
                                            <div class="form-group">
                                            {% render_label ActionPlanForm.projected_casualties class="control-label" %}
                                            {% render_field ActionPlanForm.projected_casualties class="form-control" value=0 %}
                                            {{ ActionPlanForm.projected_casualties.errors }}
                                            </div>
                                            <div class="form-group">
                                                {% render_label ActionPlanForm.duration_type class="control-label" %}
                                                {% render_field ActionPlanForm.duration_type class="form-control" %}
                                            </div>
                                            <div class="form-group">
                                                {% render_label ActionPlanForm.duration_count class="control-label" %}
                                                {% render_field ActionPlanForm.duration_count class="form-control" value=0 %}
                                            </div>
                                            {{ ActionPlanForm.duration_type.errors }}
                                            {{ ActionPlanForm.duration_count.errors }}
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        {% render_label ActionPlanForm.description class="control-label" %}
                                        {% render_field ActionPlanForm.description class="form-control" rows=20 %}
                                        {{ ActionPlanForm.description.errors }}
                                    </div>
                                    <button type="submit" class="btn btn-save" name="submitType" value="Save">Save Action Plan</button>
                                    <button type="submit" class="btn btn-success" name="submitType" value="Submit">Submit Action Plan</button>
                                </form>
                            </div>
                            <div role="tabpanel" class="tab-pane fade" id="previous" aria-labelledby="previous-tab">
                              {% include 'analyst/ui_components/action_plan_table.html' %}
                            </div>
                          </div>
                        </div>
                    </div>
                    <div id="comments" class="col-sm-3 col-xs-12">
                        <div class="profile_title">
                            <div class="col-sm-12 col-xs-12 right-col">
                                <h2><i class="fa fa-comments"></i>Comments</h2>
                            </div>
                        </div>
                        <div class="x_content">
                            <div class="mail_list_column">
                                {% for actionPlan in ActionPlanList %}
                                    {% if actionPlan.comment %}
                                    <div class="mail_list">
                                        <div style="padding-left: 1em;">
                                            <h3>{{actionPlan.comment.get_author_display}}</h3>
                                            <div>
                                                <p class="small"><span style="float:left">Plan Number: {{ actionPlan.plan_number }}</span>&nbsp<span style="float:right">{{actionPlan.comment.timeCreated}}</span></p>
                                            </div>
                                            <p>{{actionPlan.comment.text}}</p>
                                        </div>
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <!--Error-->
    <div class="row">
        <br>

        <div class="x_title row">
            <div class="col-md-5 col-sm-5 col-xs-10 "></div>

            <div class="col-md-2 col-sm-4 col-xs-6 ">
                <h1><b> 404  <span class="red glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span></b></h1>
            </div>

        </div>
        <br><br>
        <div class="row">
            <div class="col-md-4 col-sm-4 col-xs-8 "></div>
            <div class="col-md-4 col-sm-4 col-xs-6 ">
                <h4>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;There isn't a crisis here.
                <span class="blue glyphicon glyphicon-search" aria-hidden="true"></span>
                </h4>
            </div>
        </div>
        <br><br>
        <div class="row">
            <div class="col-md-3 col-sm-3 col-xs-6 "></div>
            <div class="col-md-6 col-sm-6 col-xs-12 ">
                <h5>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    We are sorry but the page you are looking for does not exist.
                </h5>
            </div>
        </div>
        <div class="row">
            <div class="col-md-4 col-sm-4 col-xs-8 "></div>
            <div class="col-md-6 col-sm-6 col-xs-12 ">
                <h5>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    Please trying again later.
                </h5>
            </div>
        </div>




    </div>
    {% endif %}
</div>
{% endblock content %}